Name:           @PACKAGE@
Version:        @VERSION@
Release:        1%{?dist}
Summary:        Moonshot Federated Identity User Interface

Group:          Security Tools
License:        BSD
URL:            http://www.project-moonshot.org/
Source0:        %{name}-%{version}.tar.xz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root

BuildRequires:      glib2-devel

%if 0%{?el6}
BuildRequires:      gtk2-devel
BuildRequires:      gnome-keyring-devel
Requires:           dejavu-sans-fonts
%else
BuildRequires:      libsecret-devel, gcr-devel
BuildRequires:      gtk3-devel
%endif

BuildRequires:      libgee-devel
BuildRequires:      dbus-devel
BuildRequires:      openssl-devel
BuildRequires:      desktop-file-utils
BuildRequires:      shared-mime-info
BuildRequires:      vala
BuildRequires:      keyutils-libs-devel
Requires:           desktop-file-utils, shared-mime-info, dbus-x11

%description


%prep
%setup -q


%build
%configure
make %{?_smp_mflags}


%install
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT%{_datadir}/dbus-1/services
ln -s ../../moonshot-ui/dbus/org.janet.Moonshot.service $RPM_BUILD_ROOT%{_datadir}/dbus-1/services/org.janet.Moonshot.service

%check
%if 0%{?el6}
# make check fails in Centos 6
%else
make check
%endif

%clean
rm -rf $RPM_BUILD_ROOT
%post
	/usr/bin/update-desktop-database
    /usr/bin/gtk-update-icon-cache -tq /usr/share/icons/hicolor 2>/dev/null ||:

%postun
	/usr/bin/update-desktop-database
    /usr/bin/gtk-update-icon-cache -tq /usr/share/icons/hicolor 2>/dev/null ||:

%package devel
Summary: Moonshot UI Development
Requires: moonshot-ui  = %{version}-%{release}

%description devel

	     Moonshot UI development




%files
%defattr(-,root,root,-)
%{_bindir}/moonshot
%{_bindir}/moonshot-webp
%{_bindir}/moonshot-keyring-tool
%{_bindir}/moonshot-idcard-generator
%{_datadir}/applications/*
%{_datadir}/dbus-1/services/*
%{_datadir}/mime/packages/*
%{_datadir}/moonshot-ui
%{_datadir}/doc/moonshot-ui
%{_libdir}/libmoonshot.so.*
%config(noreplace) %{_sysconfdir}/moonshot/*
%doc webprovisioning/default-identity.msht
%{_datadir}/icons/hicolor/scalable/apps/*

%files devel
%{_includedir}/*.h
%{_libdir}/libmoonshot.a
%{_libdir}/libmoonshot.so
%exclude %{_libdir}/*.la

%changelog
* Mon 03 Jun 2019 Jisc <moonshot@jisc.ac.uk> - 1.2.6-1
- TBD

* Mon 03 Jun 2019 Jisc <moonshot@jisc.ac.uk> - 1.2.5-1
- Make sure we disconnect from DBUS when we started the server and the DBUS
  session.

* Mon 03 Jun 2019 Jisc <moonshot@jisc.ac.uk> - 1.2.4-1
- Allow using the TEXT UI without explicitly launching a DBUS session. This
  works only with the FLAT_FILE and ENCRYPTED_FLAT_FILE.

* Tue 07 May 2019 Jisc <moonshot@jisc.ac.uk> - 1.2.3-1
- Restore support for loading direct-password ENCRIPTED_FLAT_FILE, in order
  to avoid loosing access to previously generated credential stores.
- Implement credential store export to WebP format.

* Fri 03 May 2019 Jisc <moonshot@jisc.ac.uk> - 1.2.2-1
- Use a key derivation function for the ENCRYPTED_FLAT_FILE backend
- Update README.cli

* Tue 30 Apr 2019 Jisc <moonshot@jisc.ac.uk> - 1.2.1-1
- Fix memory issue.

* Fri 26 Apr 2019 Jisc <moonshot@jisc.ac.uk> - 1.2.0-1
- Support AES-GCM encrypted flat files using kernel session keyring.
- UI layout adjustments

* Sat 30 Mar 2019 Jisc <moonshot@jisc.ac.uk> - 1.1.11-1
- Minor improvements to the TXT UI and moonshot-idcard-generator

* Wed 20 Mar 2019 Jisc <moonshot@jisc.ac.uk> - 1.1.10-1
- Homogenise TXT and GTK UI and factorise shared code

* Mon 04 Mar 2019 Jisc <moonshot@jisc.ac.uk> - 1.1.9-1
- Add a "Show Certificate" button when confirming Trust Anchor.

* Wed 27 Feb 2019 Jisc <moonshot@jisc.ac.uk> - 1.1.8-1
- Fix window being too wide when confirming Trust Anchors
- Update source URL
- Improve how keyring is handled for non-desktop environments.
- Support decorated NAIs when confirming Trust Anchors

* Sat 02 Feb 2019 Jisc <moonshot@jisc.ac.uk> - 1.1.7
- Build source packages
- Make use of GCR to provide secure memory when using libsecret

* Sun 27 Jan 2019 Jisc <moonshot@jisc.ac.uk> - 1.1.6-0
- Fix regression with libsecret handling that precluded editing Id Cards.

* Mon 21 Jan 2019 Jisc <moonshot@jisc.ac.uk> - 1.1.5-0
- Include Debian Buster build

* Thu 20 Dec 2018 Jisc <moonshot@jisc.ac.uk> - 1.1.4-0
- Support building with GTK3
- Support building with libsecret

* Tue 27 Nov 2018 Jisc <moonshot@jisc.ac.uk> - 1.1.3-0
- Package for release

* Tue 11 Sep 2018 Jisc <moonshot@jisc.ac.uk> - 1.1.2-0
- Package for release

* Thu 30 Aug 2018 Jisc <moonshot@jisc.ac.uk> - 1.1.1-0
- Package for release

* Fri 15 Jun 2018 Painless Security <build@painless-security.com> - 1.1.0-1
- Package for release

* Thu 14 Jun 2018 Painless Security <build@painless-security.com> - 1.1.0.2-1
- Send blank strings when moonshot_get_identity() nai/password are null

* Tue 12 Jun 2018 Painless Security <build@painless-security.com> - 1.1.0.1-1
- Replace dbus-glib and libdbus with GDBus
- Use dbus-daemon instead of dbus-launch in libmoonshot
- Give better error messages when DBus connection fails

* Tue 01 Aug 2017 Painless Security <build@painless-security.com> - 1.0.6-2
- Version number bump

* Tue 25 Jul 2017 Painless Security <build@painless-security.com> - 1.0.5-1
- Version number bump

* Sun 09 Jul 2017 Sam Hartman <hartmans@debian.org> - 1.0.3-2
- Upload to debian experimental, Closes: #864957

* Tue 30 May 2017 Painless Security <build@painless-security.com> - 1.0.3-1
- Various stability fixes.

* Sat 11 Feb 2017 Painless Security <build@painless-security.com> - 1.0.2-2
- Updated changelog

* Mon 31 Oct 2016 Dan Breslau <dbreslau@painless-security.com> - 1.0.2-1
- Updated changelog

* Mon 31 Oct 2016 Dan Breslau <dbreslau@painless-security.com> - 1.0.0-1
- UI has been redesigned
- Moonshot now asks user to confirm the server's fingerprint if none is 
  configured, or warns if mismatch.

* Wed 15 Jul 2015 Sam Hartman <hartmans@debian.org> - 0.7.2-1
- New upstream Version, Closes: #787880
- Force vala run and support libgee-dev and libgee-0.8-dev so we can
  build wheezy and jessie versions from the same sources.
- High urgency to avoid moonshot-ui being removed from jessie.  The
  actual code change is very simple and will either cause a build
  failure or just work.

* Thu 21 May 2015 Sam Hartman <hartmans@debian.org> - 0.7.1-3
- Depend on libgee-0.8-dev, Closes: #784651

* Wed 25 Mar 2015 Sam Hartman <hartmans@debian.org> - 0.7.1-2
- Merge in upstream change to properly decode base64 certificates with
  whitespace.

* Wed 03 Sep 2014 Sam Hartman <hartmans@debian.org> - 0.7.1-1
- New upstream version
- Move dbus launch script to libmoonshot1
- Because the dbus interface between moonshot-ui and libmoonshot1 may
  not be entirely stable, create versioned dependency.
- Initial upload to Debian, Closes: #760411

* Fri 23 May 2014 Sam Hartman <hartmans@debian.org> - 0.7-2
- Depend on dbus-x11 for dbus-launch

* Mon 19 May 2014 Sam Hartman <hartmans@debian.org> - 0.7-1
- New upstream version

* Wed 13 Nov 2013 Sam Hartman <hartmans@debian.org> - 0.6-8
- Update handling of requests containing passwords and avoid duplicate
  identity

* Tue 29 Oct 2013 Sam Hartman <hartmans@debian.org> - 0.6-7
- Merge in upstream support for flatstore-users

* Tue 29 Oct 2013 Sam Hartman <hartmans@debian.org> - 0.6-6
- Merge upstream bug fixes

* Thu 10 Oct 2013 Sam Hartman <hartmans@debian.org> - 0.6-5
- Install default identity example

* Thu 10 Oct 2013 Sam Hartman <hartmans@debian.org> - 0.6-4
- Add debug info package

* Tue 08 Oct 2013 Sam Hartman <hartmans@debian.org> - 0.6-3
- Include gnome keyring and moonshot-webp fixes

* Thu 03 Oct 2013 Sam Hartman <hartmans@debian.org> - 0.6-2
- New upstream version
- Increment shlibs version for libmoonshot

* Thu 16 May 2013 Kevin Wasserman <krwasserman@painless-security.com> - 0.5.20130510-1.1
- New upstream version
- Fix headless add identity cards

* Fri 10 May 2013 Sam Hartman <hartmans@debian.org> - 0.5.20130510-1
- New upstream version

* Tue 30 Apr 2013 Sam Hartman <hartmans@debian.org> - 0.5.20130429-3
- Fix assertion on no identities

* Tue 30 Apr 2013 Sam Hartman <hartmans@debian.org> - 0.5.20130429-2
- Updates to fix assertion failure

* Mon 29 Apr 2013 Sam Hartman <hartmans@debian.org> - 0.5.20130429-1
- New Upstream version

* Sun 21 Apr 2013 Sam Hartman <hartmans@debian.org> - 0.5.20130421-2
- New upstream version
- Fix service removal
- Fix bogus identities

* Tue 26 Mar 2013 Sam Hartman <hartmans@debian.org> - 0.5.20130326-1
- New upstream version
- Fixes headless operation

* Tue 19 Mar 2013 Sam Hartman <hartmans@debian.org> - 0.0.2.20130319-1
- Merge in upstream changes
- Script for auto dbus launch in headless

* Fri 18 May 2012 Sam Hartman <hartmans@project-moonshot.org> - 0.0.2.20120131-2
- Update from master branch

* Tue 31 Jan 2012 Sam Hartman <hartmans@project-moonshot.org> - 0.0.2.20120131-1
- New upstream version

* Thu 19 Jan 2012 Sam Hartman <hartmans@project-moonshot.org> - 0.0.2.20120119-1
- New upstream version

* Tue 17 Jan 2012 Sam Hartman <hartmans@project-moonshot.org> - 0.0.2.20120117-1
- New upstream version

* Tue 13 Sep 2011 Sam Hartman <hartmans@project-moonshot.org> - 0.0.2.20110913-2
- Fix shared libraries

* Tue 13 Sep 2011 Sam Hartman <hartmans@project-moonshot.org> - 0.0.2.20110913-1
- New upstream version

* Mon 04 Jul 2011 Sam Hartman <hartmans@debian.org> - 0.0.2.20110704-1
- New Upstream version

* Mon 13 Jun 2011 Sam Hartman <hartmans@debian.org> - 0.0.2.20110621-1
- New Upstream release

* Wed 04 May 2011 Sam Hartman <hartmans@debian.org> - 0.0.1.20110504-1
- Initial release
